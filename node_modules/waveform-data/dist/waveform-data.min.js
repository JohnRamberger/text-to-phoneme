!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).WaveformData=e()}(this,(function(){"use strict";function t(t,e){this._waveformData=t,this._channelIndex=e}t.prototype.min_sample=function(t){var e=2*(t*this._waveformData.channels+this._channelIndex);return this._waveformData._at(e)},t.prototype.max_sample=function(t){var e=2*(t*this._waveformData.channels+this._channelIndex)+1;return this._waveformData._at(e)},t.prototype.set_min_sample=function(t,e){var n=2*(t*this._waveformData.channels+this._channelIndex);return this._waveformData._set_at(n,e)},t.prototype.set_max_sample=function(t,e){var n=2*(t*this._waveformData.channels+this._channelIndex)+1;return this._waveformData._set_at(n,e)},t.prototype.min_array=function(){return this._waveformData._offsetValues(0,this._waveformData.length,2*this._channelIndex)},t.prototype.max_array=function(){return this._waveformData._offsetValues(0,this._waveformData.length,2*this._channelIndex+1)};var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=!!(e===e.window&&e.URL&&e.Blob&&e.Worker);function a(t,a){var s,r=this;if(a=a||{},n)return s=t.toString().trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],new e.Worker(e.URL.createObjectURL(new e.Blob([s],{type:"text/javascript"})));this.self=a,this.self.postMessage=function(t){setTimeout((function(){r.onmessage({data:t})}),0)},setTimeout(t.bind(a,a),0)}a.prototype.postMessage=function(t){var e=this;setTimeout((function(){e.self.onmessage({data:t})}),0)};var s=a;function r(t){this._listeners={},t.call(this)}function i(t,e){var n=new(t.disable_worker?r:s)((function(){var t=127,e=-128;this.addEventListener("message",(function n(a){if(a.data.audio_buffer){var s,r,i=a.data.scale,o=a.data.amplitude_scale,l=a.data.split_channels,h=a.data.audio_buffer,f=h.channels,c=l?f.length:1,u=1===c?1:2,_=1===u?20:24,p=function(t,e){var n=Math.floor(t/e);return t-n*e>0&&n++,n}(h.length,i),m=new ArrayBuffer(_+2*p*c),d=new DataView(m),w=0,v=h.length,g=_,y=new Array(c),b=new Array(c);for(s=0;s<c;s++)y[s]=1/0,b[s]=-1/0;for(d.setInt32(0,u,!0),d.setUint32(4,1,!0),d.setInt32(8,h.sampleRate,!0),d.setInt32(12,i,!0),d.setInt32(16,p,!0),2===u&&d.setInt32(20,c,!0),r=0;r<v;r++){var I=0;if(1===c){for(s=0;s<f.length;++s)I+=f[s][r];(I=Math.floor(t*I*o/f.length))<y[0]&&(y[0]=I,y[0]<e&&(y[0]=e)),I>b[0]&&(b[0]=I,b[0]>t&&(b[0]=t))}else for(s=0;s<c;++s)(I=Math.floor(t*f[s][r]*o))<y[s]&&(y[s]=I,y[s]<e&&(y[s]=e)),I>b[s]&&(b[s]=I,b[s]>t&&(b[s]=t));if(++w===i){for(s=0;s<c;s++)d.setInt8(g++,y[s]),d.setInt8(g++,b[s]),y[s]=1/0,b[s]=-1/0;w=0}}if(w>0)for(s=0;s<c;s++)d.setInt8(g++,y[s]),d.setInt8(g++,b[s]);this.postMessage(m,[m]),this.removeEventListener("message",n),this.close()}}))}));n.addEventListener("message",(function t(a){a.data.audio_buffer||(e(a.data),n.removeEventListener("message",t))})),n.postMessage(t)}function o(t){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o(t)}function l(e){if(function(t){return t&&"object"===o(t)&&"sample_rate"in t&&"samples_per_pixel"in t&&"bits"in t&&"length"in t&&"data"in t}(e)&&(e=function(t){var e=t.data,n=t.channels||1,a=8===t.bits?1:2,s=2*t.length*n;if(e.length!==s)throw new Error("WaveformData.create(): Length mismatch in JSON waveform data");var r=24+e.length*a,i=new ArrayBuffer(r),o=new DataView(i);o.setInt32(0,2,!0),o.setUint32(4,8===t.bits,!0),o.setInt32(8,t.sample_rate,!0),o.setInt32(12,t.samples_per_pixel,!0),o.setInt32(16,t.length,!0),o.setInt32(20,n,!0);var l,h=24;if(8===t.bits)for(l=0;l<e.length;l++)o.setInt8(h++,e[l],!0);else for(l=0;l<e.length;l++)o.setInt16(h,e[l],!0),h+=2;return i}(e)),!function(t){var e=t&&"object"===o(t)&&"byteLength"in t;if(e){var n=new DataView(t).getInt32(0,!0);if(1!==n&&2!==n)throw new TypeError("WaveformData.create(): This waveform data version not supported")}return e}(e))throw new TypeError("WaveformData.create(): Unknown data format");this._data=new DataView(e),this._offset=2===this._version()?24:20,this._channels=[];for(var n=0;n<this.channels;n++)this._channels[n]=new t(this,n)}r.prototype.addEventListener=function(t,e){this._listeners[t]||(this._listeners[t]=[]),this._listeners[t].push(e)},r.prototype.removeEventListener=function(t,e){this._listeners[t]&&(this._listeners[t]=this._listeners[t].filter((function(t){return t!==e})))},r.prototype.postMessage=function(t){for(var e={data:t},n=this._listeners.message,a=0;a<n.length;a++)n[a].call(this,e)},r.prototype.close=function(){this._listeners={}};var h=512,f=1,c=!1,u=!1;function _(t,e,n){for(var a={length:t.length,sampleRate:t.sampleRate,channels:[]},s=0;s<t.numberOfChannels;++s)a.channels[s]=t.getChannelData(s);i({scale:e.scale,amplitude_scale:e.amplitude_scale,split_channels:e.split_channels,audio_buffer:a,disable_worker:e.disable_worker},(function(e){n(null,new l(e),t)}))}return l.create=function(t){return new l(t)},l.createFromAudio=function(t,e){var n=function(t){return{scale:t.scale||h,amplitude_scale:t.amplitude_scale||f,split_channels:t.split_channels||c,disable_worker:t.disable_worker||u}}(t);if(t.audio_context&&t.array_buffer)return function(t,e,n,a){t.decodeAudioData(e,(function(t){_(t,n,a)}),(function(t){t||(t=new DOMException("EncodingError")),a(t)}))}(t.audio_context,t.array_buffer,n,e);if(t.audio_buffer)return _(t.audio_buffer,n,e);throw new TypeError("WaveformData.createFromAudio(): Pass either an AudioContext and ArrayBuffer, or an AudioBuffer object")},l.prototype={resample:function(t){if(t.scale="number"==typeof t.scale?t.scale:null,t.width="number"==typeof t.width?t.width:null,null!=t.width&&t.width<=0)throw new RangeError("WaveformData.resample(): width should be a positive integer value");if(null!=t.scale&&t.scale<=0)throw new RangeError("WaveformData.resample(): scale should be a positive integer value");if(!t.scale&&!t.width)throw new Error("WaveformData.resample(): Missing scale or width option");var e=t.scale||Math.floor(this.duration*this.sample_rate/t.width),n=this.scale,a=this.length,s=a*this.scale,r=Math.ceil(s/e),i=8===this.bits?1:2,o=24+2*r*this.channels*i,h=new ArrayBuffer(o),f=new DataView(h);f.setInt32(0,2,!0),f.setUint32(4,8===this.bits,!0),f.setInt32(8,this.sample_rate,!0),f.setInt32(12,e,!0),f.setInt32(16,r,!0),f.setInt32(20,this.channels,!0);var c,u=new l(h),_=0,p=0,m=this.channels,d=new Array(m),w=new Array(m);for(c=0;c<m;++c)a>0?(d[c]=this.channel(c).min_sample(_),w[c]=this.channel(c).max_sample(_)):(d[c]=0,w[c]=0);var v,g,y,b,I=8===this.bits?-128:-32768,D=8===this.bits?127:32767;if(e<n)throw new Error("WaveformData.resample(): Zoom level "+e+" too low, minimum: "+n);function x(t){return Math.floor(t*e)}for(;_<a;){for(;Math.floor(x(p)/n)===_;){if(p>0)for(c=0;c<m;++c)u.channel(c).set_min_sample(p-1,d[c]),u.channel(c).set_max_sample(p-1,w[c]);if(b=_,(v=x(++p))!==x(p-1))for(c=0;c<m;++c)d[c]=D,w[c]=I}for(v=x(p),(g=Math.floor(v/n))>a&&(g=a);_<g;){for(c=0;c<m;++c)(y=this.channel(c).min_sample(_))<d[c]&&(d[c]=y),(y=this.channel(c).max_sample(_))>w[c]&&(w[c]=y);_++}}if(_!==b)for(c=0;c<m;++c)u.channel(c).set_min_sample(p-1,d[c]),u.channel(c).set_max_sample(p-1,w[c]);return u},concat:function(){var t=this,e=Array.prototype.slice.call(arguments);e.forEach((function(e){if(t.channels!==e.channels||t.sample_rate!==e.sample_rate||t.bits!==e.bits||t.scale!==e.scale)throw new Error("WaveformData.concat(): Waveforms are incompatible")}));var n=this._concatBuffers.apply(this,e);return l.create(n)},_concatBuffers:function(){var t,e,n=Array.prototype.slice.call(arguments),a=this._offset,s=a,r=0,i=[this].concat(n).map((function(t){return t._data.buffer}));for(t=0;t<i.length;t++){e=i[t];var o=new DataView(e).getInt32(16,!0);s+=e.byteLength-a,r+=o}var l=new ArrayBuffer(s),h=new DataView(i[0]),f=new DataView(l);for(t=0;t<a;t++)f.setUint8(t,h.getUint8(t));f.setInt32(16,r,!0);var c=0,u=new Uint8Array(l,a);for(t=0;t<i.length;t++)e=i[t],u.set(new Uint8Array(e,a),c),c+=e.byteLength-a;return l},_offsetValues:function(t,e,n){var a=[],s=this.channels;n+=t*s*2;for(var r=0;r<e;r++)a.push(this._at(r*s*2+n));return a},_version:function(){return this._data.getInt32(0,!0)},get length(){return this._data.getUint32(16,!0)},get bits(){return Boolean(this._data.getUint32(4,!0))?8:16},get duration(){return this.length*this.scale/this.sample_rate},get pixels_per_second(){return this.sample_rate/this.scale},get seconds_per_pixel(){return this.scale/this.sample_rate},get channels(){return 2===this._version()?this._data.getInt32(20,!0):1},channel:function(t){if(t>=0&&t<this._channels.length)return this._channels[t];throw new RangeError("Invalid channel: "+t)},get sample_rate(){return this._data.getInt32(8,!0)},get scale(){return this._data.getInt32(12,!0)},_at:function(t){return 8===this.bits?this._data.getInt8(this._offset+t):this._data.getInt16(this._offset+2*t,!0)},_set_at:function(t,e){return 8===this.bits?this._data.setInt8(this._offset+t,e):this._data.setInt16(this._offset+2*t,e,!0)},at_time:function(t){return Math.floor(t*this.sample_rate/this.scale)},time:function(t){return t*this.scale/this.sample_rate},toJSON:function(){for(var t={version:2,channels:this.channels,sample_rate:this.sample_rate,samples_per_pixel:this.scale,bits:this.bits,length:this.length,data:[]},e=0;e<this.length;e++)for(var n=0;n<this.channels;n++)t.data.push(this.channel(n).min_sample(e)),t.data.push(this.channel(n).max_sample(e));return t},toArrayBuffer:function(){return this._data.buffer}},l}));
//# sourceMappingURL=waveform-data.min.js.map
